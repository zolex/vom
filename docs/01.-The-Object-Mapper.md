[![Release](https://github.com/zolex/vom/workflows/Release/badge.svg)](https://github.com/zolex/vom/actions/workflows/release.yaml)
[![Version](https://img.shields.io/packagist/v/zolex/vom)](https://packagist.org/packages/zolex/vom)
[![Integration](https://github.com/zolex/vom/workflows/Integration/badge.svg)](https://github.com/zolex/vom/actions/workflows/integration.yaml)
[![Code Coverage](https://codecov.io/gh/zolex/vom/graph/badge.svg?token=RI2NX4S89I)](https://codecov.io/gh/zolex/vom)
[![License](https://img.shields.io/packagist/l/zolex/vom)](./LICENSE)
[![Downloads](https://img.shields.io/packagist/dt/zolex/vom)](https://packagist.org/packages/zolex/vom)

![VOM](https://raw.githubusercontent.com/zolex/vom/refs/heads/master/docs/logo.png)

![PHP](https://img.shields.io/badge/php-%23777BB4.svg?style=for-the-badge&logo=php&logoColor=white)
![Symfony](https://img.shields.io/badge/symfony-%23000000.svg?style=for-the-badge&logo=symfony&logoColor=white)
![Laravel](https://img.shields.io/badge/laravel-%23FF2D20.svg?style=for-the-badge&logo=laravel&logoColor=white)


The Versatile Object Mapper - or in short VOM - is a PHP library to transform any data structure into strictly typed models (and back) by adding PHP 8 attributes.
It extends symfony/serializer functionality and is heavily inspired by doctrine and API-Platform, so that advanced mappings can simply be defined on the model classes instead of writing normalizer decorators.

## Topic Overview

[00. Installation and Integration](00.-Installation-and-Integration.md#installation-and-integration) \
[01. The ObjectMapper](01.-The-Object-Mapper.md#the-object-mapper) \
[02. Property Attribute](02.-Property-Attribute.md#the-property-attribute) \
[03. Disable Nesting](03.-Disable-Nesting.md#disable-nesting) \
[04. Root and Relative Accessor](04.-Root-and-Relative-Accessor.md#root-and-relative-accessor) \
[05. Data Types](05.-Data-Types.md#data-types) \
[06. Collections](06.-Collections.md#collections) \
[07. Constructor Arguments](07.-Constructor-Arguments.md#constructor-arguments) \
[08. Factories](08.-Factories.md#factories) \
[09. Denormalizer Methods](09.-Denormalizer-Methods.md#denormalizer-methods) \
[10. Normalizer Methods](10.-Normalizer-Methods.md#normalizer-methods) \
[11. Method Dependencies](11.-Method-Dependencies.md#method-dependencies) \
[12. RegExp Extractors](12.-RegExp-Extractors.md#regular-expression-extractors) \
[13. Serialized Argument](13.-Serialized-Argument.md#serialized-argument) \
[14. Consistency](14.-Consistency.md#consistency) \
[15. Scenarios](15.-Scenarios.md#scenarios) \
[16. Interfaces and Abstract Classes](16.-Interfaces-and-Abstract-Classes.md#interfaces-and-abstract-classes) \
[17. Context](17.-Context.md#context)

# The Object Mapper

## Get the OjectMapper

### Plain old PHP

Without a framework, you can construct the mapper yourself or simply use the included factory.
Also see the [plain php example](https://github.com/zolex/vom-examples/tree/main/without-framework).
You can pass the `create()` method any `\Psr\Cache\CacheItemPoolInterface` to cache the model's metadata and avoid analyzing it on each execution of your application.

```php
$objectMapper = \Zolex\VOM\Serializer\Factory\VersatileObjectMapperFactory::create();
```

### Laravel

In Laravel the `VersatileObjectMapper` is registered for dependency injection. Also see the [Laravel example with Dependency Injection](https://github.com/zolex/vom-examples/tree/main/laravel).

```php
use Zolex\VOM\Serializer\VersatileObjectMapper;

class ExampleController
{
    public function __construct(private VersatileObjectMapper $objectMapper)
    {
    }
    
    public function deserialize(): void
    {
        $person = $this->objectMapper->deserialize('{"id": 123, "firstname": "Peter"}', Person::class);
    }
}
```

If you prefer, you can also get a VOM instance using Laravel's `app()` or `resolve()` etc.

```php
$objectMapper = resolve(VersatileObjectMapper::class);
$objectMapper = app(VersatileObjectMapper::class);
```

### Symfony

In symfony framework you should use dependency injection to gain access to the preconfigured object mapper service. Also see the [Symfony example](https://github.com/zolex/vom-examples/tree/main/symfony-framework).
The recommended way to use it is by type-hinting Symfony's `SerializerInterface` or `VersatileObjectMapper`.

The only difference is, that `VersatileObjectMapper` by default processes the VOM attributes and the standard symfony serializer needs additional context to enable the VOM features.

```php
use Zolex\VOM\Serializer\VersatileObjectMapper;

class AnySymfonyService
{
    public function __construct(private VersatileObjectMapper $objectMapper)
    {
    }
    
    public function deserialize(): void
    {
        $person = $this->objectMapper->deserialize('{"id": 123, "firstname": "Peter"}', Person::class);
    }
}
```

Symfony Serializer needs additional context to utilize the Versatile Object Mapper. This is required to not interfere with the framework's behavior if not explicitly wanted.
A particular use-case where it would otherwise produce unwanted results is API-Platform, where it would always return the VOM-normalized data if VOM wasn't disabled by default.

_For technical details, check the [StateProvider](https://github.com/zolex/vom-examples/tree/main/api-platform-custom-state/src/State/PersonStateProvider.php) and the [Person Resource](https://github.com/zolex/vom-examples/tree/main/api-platform-custom-state/src/ApiResource/Person.php) in the API-Platform example with custom state
as well as the [Person Resource](https://github.com/zolex/vom-examples/tree/main/api-platform-doctrine/src/Entity/Person.php) in the API-Platform example with Doctrine._

```php
use Symfony\Component\Serializer\SerializerInterface;
class AnySymfonyService
{
    public function __construct(private SerializerInterface $serializer)
    {
    }
    
    public function deserialize(): void
    {
        $person = $this->serializer->deserialize('{"id": 123, "firstname": "Peter"}', Person::class, context: ['vom' => true]);
    }
}
```

> [!TIP]
> The `PropertyInfoExtractorFactory` creates a default set of extractors utilizing Reflection and PhpDoc. Several other extractors are available in Symfony, such as PHPStan and Doctrine. You can also write a custom extractor to give VOM additional information on your model's properties.

## Run the ObjectMapper

### Denormalization

Denormalization is the process of mapping arbitrary, untyped data to strictly typed models. Other well known synonyms for this process are hydration or transformation.

If your data already is an array you can call the `denormalize()` method on the mapper to create a model instance from it.

```php
$person = $objectMapper->denormalize($data, Person::class);
```

### Normalization

Normalization is VOM's process of mapping a strictly typed model to an arbitrary array with eventually untyped or at least not strictly typed values.

If you need a native php array representation of your model you can call the `normalize()` method and pass it your model.

```php
$array = $objectMapper->normalize($personModel);
```

### Object Representation

If you need the normalized data to be converted to an object, use VOM's static `toObject()` method and pass it the normalization result.
This is not simple casting, but recursively converts the whole data structure to an `stdClass`, just leaving indexed, sequential arrays intact.

```php
$object = \Zolex\VOM\Serializer\VersatileObjectMapper::toObject($array);
```

### Deserialization

VOM can process several kinds of serialized data, such as JSON or XML. To create a model instance from the string, simply call the `deserialize()` method on the mapper.

```php
$person = $objectMapper->deserialize($jsonString, Person::class);
```

### Serialization

To create a string representation of a model, such as JSON, you can call the `serialize()` method on the object mapper.

```php
$jsonString = $objectMapper->serialize($personModel, 'json'); // json is the default
```

\
\
Continue reading - [02. Property Attribute](02.-Property-Attribute.md)